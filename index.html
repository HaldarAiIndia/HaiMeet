<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>HaiMeet â€” Random Video Chat</title>
<link rel="icon" type="image/png" href="/favicon1.png">
<meta name="description" content="HaiMeet is a free random video chat platform. Meet strangers instantly. Safe, anonymous, global.">
<meta name="theme-color" content="#5b4fcf" id="meta-theme">

<!-- PWA Meta -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="HaiMeet">

<link rel="apple-touch-icon" href="favicon1.png">

<!-- Inline Manifest -->
<script>
const manifestData = {
  name: "HaiMeet â€” Random Video Chat",
  short_name: "HaiMeet",
  start_url: ".",
  display: "standalone",
  background_color: "#5b4fcf",
  theme_color: "#5b4fcf",
  orientation: "portrait",
  icons: [
    {
      src: "favicon1.png",
      sizes: "192x192",
      type: "image/png"
    },
    {
      src: "favicon1.png",
      sizes: "512x512",
      type: "image/png"
    }
  ]
};

const blob = new Blob([JSON.stringify(manifestData)], { type: "application/json" });
const manifestURL = URL.createObjectURL(blob);
const link = document.createElement("link");
link.rel = "manifest";
link.href = manifestURL;
document.head.appendChild(link);
</script>
  
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20,500,1,0" rel="stylesheet">
<style>

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   DESIGN TOKENS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
:root {
  --c-bg:         #f4f2ff;
  --c-surface:    #ffffff;
  --c-surface-2:  #ece9ff;
  --c-surface-3:  #f9f8ff;
  --c-text:       #16122b;
  --c-text-2:     #7268a0;
  --c-text-3:     #b0a8d0;
  --c-primary:    #5b4fcf;
  --c-primary-lt: #7c6fdb;
  --c-primary-bg: #ede9ff;
  --c-border:     #e2deff;
  --c-green:      #22c55e;
  --c-red:        #ef4444;
  --c-amber:      #f59e0b;
  --c-shadow-sm:  0 1px 3px rgba(91,79,207,.07), 0 4px 12px rgba(91,79,207,.06);
  --c-shadow-md:  0 4px 20px rgba(91,79,207,.12), 0 2px 6px rgba(0,0,0,.04);
  --c-shadow-lg:  0 12px 48px rgba(91,79,207,.2), 0 4px 16px rgba(0,0,0,.08);
  --r-card: 24px;
  --r-pill: 100px;
  --r-btn:  18px;
  --safe-t: env(safe-area-inset-top);
  --safe-b: env(safe-area-inset-bottom);
}
[data-theme="dark"] {
  --c-bg:         #100e1c;
  --c-surface:    #1a1728;
  --c-surface-2:  #221f35;
  --c-surface-3:  #16132a;
  --c-text:       #ede9ff;
  --c-text-2:     #8a80b8;
  --c-text-3:     #4a4470;
  --c-primary:    #7c72e8;
  --c-primary-lt: #9c94ef;
  --c-primary-bg: #241f45;
  --c-border:     #2e2850;
  --c-shadow-sm:  0 1px 3px rgba(0,0,0,.3);
  --c-shadow-md:  0 4px 20px rgba(0,0,0,.4);
  --c-shadow-lg:  0 12px 48px rgba(0,0,0,.5);
}

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   BASE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
/* FIX: .ms shorthand must inherit the Material Symbols font */
.ms {
  font-family: 'Material Symbols Rounded';
  font-weight: normal;
  font-style: normal;
  font-size: 24px;
  line-height: 1;
  letter-spacing: normal;
  text-transform: none;
  display: inline-block;
  white-space: nowrap;
  word-wrap: normal;
  direction: ltr;
  -webkit-font-smoothing: antialiased;
  font-feature-settings: 'liga';
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body {
  height: 100%; overflow: hidden;
  font-family: 'Plus Jakarta Sans', sans-serif;
  background: var(--c-bg); color: var(--c-text);
  -webkit-tap-highlight-color: transparent;
  overscroll-behavior: none;
  user-select: none; -webkit-user-select: none;
}

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   VIEWS
   FIX: removed opacity/transform hide â€” use visibility + translateY only.
        Inactive views are pointer-events:none + visibility:hidden so they
        don't block taps or cause layout shifts during transitions.
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
.view {
  position: fixed; inset: 0;
  display: flex; flex-direction: column;
  background: var(--c-bg);
  visibility: hidden;
  opacity: 0;
  transform: translateY(20px) scale(.985);
  transition: opacity .28s ease, transform .32s cubic-bezier(.22,.9,.22,1), visibility 0s .32s;
  z-index: 10;
  pointer-events: none;
}
.view.active {
  visibility: visible; opacity: 1;
  transform: translateY(0) scale(1);
  transition: opacity .28s ease, transform .32s cubic-bezier(.22,.9,.22,1), visibility 0s 0s;
  z-index: 20;
  pointer-events: auto;
}

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   DASHBOARD
   FIX: overflow-y:auto added directly so it scrolls.
        padding-bottom accounts for the fixed FAB.
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
#dash {
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-top: calc(20px + var(--safe-t));
  padding-bottom: calc(96px + var(--safe-b));
}
#dash::-webkit-scrollbar { display: none; }

.dash-inner { padding: 0 18px; display: flex; flex-direction: column; gap: 16px; }

/* â€” Topbar â€” */
.topbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 18px; margin-bottom: 4px;
}
.brand { display: flex; align-items: center; gap: 10px; }
.brand-mark {
  width: 40px; height: 40px; border-radius: 14px;
  background: linear-gradient(145deg, #6b5fe6, #4a3fcf);
  display: grid; place-items: center;
  box-shadow: 0 4px 16px rgba(91,79,207,.45), inset 0 1px 0 rgba(255,255,255,.25);
}
.brand-mark .ms { color: #fff; font-size: 22px; }
.brand-name {
  font-size: 24px; font-weight: 900; letter-spacing: -.7px;
  background: linear-gradient(135deg, var(--c-primary), #9b59f5);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}

.topbar-right { display: flex; gap: 8px; }
.icon-btn {
  width: 40px; height: 40px; border-radius: 14px;
  background: var(--c-surface); border: 1.5px solid var(--c-border);
  display: grid; place-items: center; cursor: pointer;
  box-shadow: var(--c-shadow-sm); color: var(--c-text-2);
  transition: background .15s, transform .1s, box-shadow .15s;
}
.icon-btn .ms { font-size: 20px; }
.icon-btn:active { transform: scale(.89); background: var(--c-surface-2); box-shadow: none; }

/* â€” Hero Banner â€” */
.hero {
  border-radius: 28px; padding: 26px 24px 24px;
  background: linear-gradient(140deg, #4a3fcf 0%, #6b3bc9 45%, #9333ea 100%);
  position: relative; overflow: hidden;
  box-shadow: 0 16px 48px -8px rgba(91,79,207,.55), 0 4px 12px rgba(0,0,0,.12);
}
.hero::before {
  content: ''; position: absolute; inset: 0;
  background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.04'%3E%3Ccircle cx='30' cy='30' r='28'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
  pointer-events: none;
}
.hero-blob {
  position: absolute; border-radius: 50%;
  background: rgba(255,255,255,.08); pointer-events: none;
}
.hero-blob-1 { width: 180px; height: 180px; top: -60px; right: -40px; }
.hero-blob-2 { width: 100px; height: 100px; bottom: -30px; right: 60px; background: rgba(255,255,255,.05); }
.hero-chip {
  display: inline-flex; align-items: center; gap: 5px;
  background: rgba(255,255,255,.18); border: 1px solid rgba(255,255,255,.3);
  backdrop-filter: blur(8px);
  border-radius: var(--r-pill); padding: 5px 12px 5px 8px;
  color: #fff; font-size: 11px; font-weight: 700;
  letter-spacing: .6px; text-transform: uppercase; margin-bottom: 14px;
}
.hero-chip .ms { font-size: 13px; }
.hero-live-dot {
  width: 6px; height: 6px; border-radius: 50%; background: #4ade80;
  box-shadow: 0 0 6px #4ade80;
  animation: livePulse 2s ease-in-out infinite;
}
@keyframes livePulse { 0%,100%{opacity:1} 50%{opacity:.4} }
.hero-title {
  font-size: 36px; font-weight: 900; color: #fff;
  line-height: 1.05; letter-spacing: -1px; margin-bottom: 10px;
  position: relative;
}
.hero-sub { color: rgba(255,255,255,.72); font-size: 14px; font-weight: 500; line-height: 1.5; position: relative; }
.hero-stats-row {
  display: flex; gap: 20px; margin-top: 20px; position: relative;
}
.hero-stat { display: flex; flex-direction: column; }
.hero-stat-num { font-size: 20px; font-weight: 800; color: #fff; line-height: 1; }
.hero-stat-lbl { font-size: 10px; font-weight: 600; color: rgba(255,255,255,.55); letter-spacing: .5px; margin-top: 2px; text-transform: uppercase; }
.hero-divider { width: 1px; background: rgba(255,255,255,.2); margin: 2px 0; }

/* â€” Form Cards â€” */
.card {
  background: var(--c-surface); border: 1.5px solid var(--c-border);
  border-radius: var(--r-card); /* FIX: was var(--c-card, var(--r-card)) â€” undefined var */
  box-shadow: var(--c-shadow-sm); overflow: hidden;
}
.card-header {
  padding: 16px 18px 0;
  font-size: 10.5px; font-weight: 800; letter-spacing: 1.2px;
  text-transform: uppercase; color: var(--c-text-2);
}
.card-body { padding: 10px 12px 12px; }

/* Name input */
.name-input-wrap {
  display: flex; align-items: center; gap: 10px;
  background: var(--c-surface-2); border: 2px solid transparent;
  border-radius: 16px; padding: 13px 16px;
  transition: border-color .2s, background .2s;
}
.name-input-wrap:focus-within {
  border-color: var(--c-primary); background: var(--c-bg);
  box-shadow: 0 0 0 4px var(--c-primary-bg);
}
.name-input-wrap .ms { font-size: 20px; color: var(--c-text-2); flex-shrink: 0; }
.name-input {
  flex: 1; background: none; border: none; outline: none;
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 16px; font-weight: 600; color: var(--c-text);
  /* FIX: allow user to type */
  user-select: text; -webkit-user-select: text;
}
.name-input::placeholder { color: var(--c-text-3); font-weight: 500; }

/* Segment */
.seg-track {
  display: flex; background: var(--c-surface-2);
  border-radius: 16px; padding: 4px; gap: 4px;
}
.seg-opt {
  flex: 1; display: flex; align-items: center; justify-content: center;
  gap: 6px; padding: 11px 8px; border-radius: 12px;
  font-size: 14px; font-weight: 700; color: var(--c-text-2);
  cursor: pointer; transition: background .18s, color .18s, box-shadow .18s;
}
.seg-opt .ms { font-size: 18px; }
.seg-opt.sel {
  background: var(--c-surface); color: var(--c-primary);
  box-shadow: 0 2px 10px rgba(91,79,207,.14), 0 1px 3px rgba(0,0,0,.06);
}

/* â€” Start Button â€” */
.start-fab {
  position: fixed; bottom: calc(20px + var(--safe-b));
  left: 18px; right: 18px; z-index: 30;
  height: 64px; border: none; border-radius: 22px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 10px;
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 17px; font-weight: 800; color: #fff;
  background: linear-gradient(135deg, #4a3fcf 0%, #7c3aed 60%, #9b59f5 100%);
  box-shadow: 0 10px 32px -4px rgba(91,79,207,.6), 0 4px 12px rgba(91,79,207,.3), inset 0 1px 0 rgba(255,255,255,.2);
  transition: transform .12s ease, box-shadow .12s ease;
  letter-spacing: -.1px;
}
.start-fab .ms { font-size: 26px; }
.start-fab:active {
  transform: scale(.97);
  box-shadow: 0 4px 16px -4px rgba(91,79,207,.4), inset 0 1px 0 rgba(255,255,255,.15);
}

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   SETTINGS SHEET
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
.overlay {
  position: fixed; inset: 0; z-index: 90;
  background: rgba(10,8,24,.6); backdrop-filter: blur(8px) saturate(1.4);
  opacity: 0; pointer-events: none; transition: opacity .3s;
}
.overlay.open { opacity: 1; pointer-events: auto; }

.sheet {
  position: fixed; left: 0; right: 0; bottom: 0; z-index: 100;
  background: var(--c-surface); border-radius: 28px 28px 0 0;
  padding: 0 20px calc(32px + var(--safe-b));
  transform: translateY(110%); transition: transform .38s cubic-bezier(.22,.9,.22,1);
  box-shadow: 0 -12px 60px rgba(0,0,0,.22);
}
.sheet.open { transform: translateY(0); }
.sheet-handle {
  width: 40px; height: 5px; border-radius: 10px;
  background: var(--c-border); margin: 14px auto 22px;
}
.sheet-head {
  display: flex; align-items: center; gap: 10px; margin-bottom: 20px;
}
.sheet-head-icon {
  width: 36px; height: 36px; border-radius: 12px;
  background: var(--c-primary-bg); display: grid; place-items: center;
}
.sheet-head-icon .ms { font-size: 20px; color: var(--c-primary); }
.sheet-head-title { font-size: 18px; font-weight: 800; }

.setting-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 15px 0; border-bottom: 1.5px solid var(--c-border);
}
/* FIX: :last-of-type doesn't work on divs reliably â€” use :last-child instead */
.setting-row:last-child { border-bottom: none; }
.setting-left { display: flex; align-items: center; gap: 12px; }
.setting-icon {
  width: 38px; height: 38px; border-radius: 12px;
  background: var(--c-surface-2); display: grid; place-items: center;
}
.setting-icon .ms { font-size: 20px; color: var(--c-primary); }
.setting-label { font-size: 15px; font-weight: 700; }
.setting-sub { font-size: 12px; color: var(--c-text-2); margin-top: 1px; font-weight: 500; }

/* iOS-style toggle */
.toggle {
  -webkit-appearance: none; appearance: none;
  width: 52px; height: 30px; border-radius: 100px;
  background: var(--c-border); cursor: pointer;
  position: relative; transition: background .25s;
  flex-shrink: 0;
}
.toggle:checked { background: var(--c-green); }
.toggle::before {
  content: ''; position: absolute;
  top: 3px; left: 3px;
  width: 24px; height: 24px; border-radius: 50%;
  background: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,.25);
  transition: transform .25s cubic-bezier(.22,.9,.22,1);
}
.toggle:checked::before { transform: translateX(22px); }

.sheet-btn {
  width: 100%; margin-top: 20px;
  height: 52px; border: none; border-radius: 16px; cursor: pointer;
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 15px; font-weight: 800; color: var(--c-primary);
  background: var(--c-primary-bg); transition: opacity .15s;
}
.sheet-btn:active { opacity: .75; }

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   CALL VIEW
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
#call { background: #07050f; }

/*
  FIX: .vids was display:grid with grid-template-rows:1fr auto but only
  ONE child element (.vid-remote). Changed to display:flex + flex-direction:column
  so .vid-remote stretches to fill all available vertical space correctly.
*/
.vids {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  padding: calc(8px + var(--safe-t)) 8px calc(104px + var(--safe-b)) 8px;
}
.vid-remote {
  /* FIX: flex:1 now works because parent is flexbox */
  flex: 1;
  border-radius: 24px; overflow: hidden; position: relative;
  background: #0e0b1a;
  min-height: 0; /* FIX: prevents flex overflow in some browsers */
}
.vid-remote video { width: 100%; height: 100%; object-fit: cover; display: block; }

/* Local video â€” PiP overlay */
.vid-local {
  position: absolute;
  bottom: calc(110px + var(--safe-b));
  right: 14px;
  width: 110px; height: 155px;
  border-radius: 18px; overflow: hidden;
  background: #111;
  box-shadow: 0 8px 28px rgba(0,0,0,.7), 0 0 0 2px rgba(255,255,255,.12);
  z-index: 20;
}
.vid-local video { width: 100%; height: 100%; object-fit: cover; display: block; }
.vid-local-badge {
  position: absolute; bottom: 8px; left: 0; right: 0;
  text-align: center;
  font-size: 11px; font-weight: 700; color: rgba(255,255,255,.8);
  text-shadow: 0 1px 4px rgba(0,0,0,.6);
  pointer-events: none;
}

/* Searching state */
.search-screen {
  position: absolute; inset: 0; border-radius: 24px;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  background: radial-gradient(ellipse at 50% 40%, #1e1440 0%, #07050f 70%);
  z-index: 10;
}
.radar {
  width: 96px; height: 96px; border-radius: 50%; position: relative;
  display: grid; place-items: center;
  border: 2px solid rgba(124,110,232,.5);
}
.radar-icon { color: var(--c-primary-lt); font-size: 30px; }
/*
  FIX: Separated radar::before and radar::after from .radar-r3.
  The original combined selector applied content:'' to .radar-r3 (a div),
  which is harmless but confusing. More importantly, keeping them separate
  makes the animation-delay explicit and avoids selector specificity issues.
*/
.radar::before,
.radar::after {
  content: '';
  position: absolute; inset: 0;
  border-radius: 50%; border: 1.5px solid var(--c-primary-lt);
  animation: radarPulse 2.4s ease-out infinite;
  opacity: 0;
}
.radar::after { animation-delay: .8s; }
.radar-r3 {
  position: absolute; inset: 0;
  border-radius: 50%; border: 1.5px solid var(--c-primary-lt);
  animation: radarPulse 2.4s ease-out infinite;
  animation-delay: 1.6s;
  opacity: 0;
  pointer-events: none;
}
@keyframes radarPulse {
  0%   { transform: scale(.9); opacity: .7; }
  100% { transform: scale(2.6); opacity: 0; }
}
.search-title {
  margin-top: 24px; font-size: 18px; font-weight: 800;
  color: rgba(255,255,255,.9); letter-spacing: -.3px;
}
.search-sub { font-size: 13px; color: rgba(255,255,255,.4); margin-top: 6px; font-weight: 500; }
.search-pulse-row { display: flex; gap: 6px; margin-top: 16px; }
.s-dot {
  width: 6px; height: 6px; border-radius: 50%; background: var(--c-primary-lt);
  animation: sDot 1s ease-in-out infinite;
}
.s-dot:nth-child(2) { animation-delay: .2s; }
.s-dot:nth-child(3) { animation-delay: .4s; }
@keyframes sDot { 0%,80%,100%{transform:scale(1);opacity:.5} 40%{transform:scale(1.5);opacity:1} }

/* Partner overlay */
.partner-tag {
  position: absolute; top: 16px; left: 16px; z-index: 8;
  display: none; align-items: center; gap: 8px;
  background: rgba(0,0,0,.5); backdrop-filter: blur(16px) saturate(1.8);
  border: 1px solid rgba(255,255,255,.14);
  border-radius: var(--r-pill); padding: 7px 16px 7px 10px;
}
.partner-avatar {
  width: 28px; height: 28px; border-radius: 50%;
  background: linear-gradient(135deg, #7c6fe8, #a855f7);
  display: grid; place-items: center;
}
.partner-avatar .ms { font-size: 16px; color: #fff; }
.partner-name { font-size: 14px; font-weight: 700; color: #fff; }
.partner-live {
  width: 8px; height: 8px; border-radius: 50%; background: var(--c-green);
  box-shadow: 0 0 8px var(--c-green); margin-left: 2px;
  animation: livePulse 1.5s ease-in-out infinite;
}

/* Timer chip */
.timer-chip {
  position: absolute; top: 16px; right: 16px; z-index: 8;
  background: rgba(0,0,0,.5); backdrop-filter: blur(16px);
  border: 1px solid rgba(255,255,255,.12);
  border-radius: var(--r-pill); padding: 7px 14px;
  font-size: 13px; font-weight: 800; color: rgba(255,255,255,.9);
  font-variant-numeric: tabular-nums; letter-spacing: .5px;
  display: none;
}

/* Chat panel */
.chat-wrap {
  position: absolute; z-index: 40;
  left: 12px; right: 12px;
  bottom: calc(106px + var(--safe-b));
  display: flex; flex-direction: column; gap: 8px;
  opacity: 0; pointer-events: none;
  transform: translateY(14px);
  transition: opacity .25s ease, transform .28s cubic-bezier(.22,.9,.22,1);
}
.chat-wrap.open { opacity: 1; pointer-events: auto; transform: none; }
.chat-msgs {
  display: flex; flex-direction: column; gap: 6px;
  max-height: 220px; overflow-y: auto;
  -webkit-mask-image: linear-gradient(to top, black 78%, transparent);
  mask-image: linear-gradient(to top, black 78%, transparent);
}
.chat-msgs::-webkit-scrollbar { display: none; }
.bubble {
  padding: 10px 16px; border-radius: 20px 20px 20px 5px;
  font-size: 14px; font-weight: 500; max-width: 78%;
  align-self: flex-start; line-height: 1.4;
  background: rgba(18,14,35,.88); backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,.1); color: #fff;
  animation: bubbleIn .2s ease;
  /* FIX: allow text selection in chat */
  user-select: text; -webkit-user-select: text;
  word-break: break-word;
}
.bubble.me {
  background: var(--c-primary);
  border: none; align-self: flex-end;
  border-radius: 20px 20px 5px 20px;
}
@keyframes bubbleIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none} }

.chat-input-row { display: flex; gap: 8px; align-items: center; }
.chat-input {
  flex: 1; background: rgba(20,16,40,.92); backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,.16); border-radius: var(--r-pill);
  padding: 13px 20px; color: #fff; outline: none;
  font-family: 'Plus Jakarta Sans', sans-serif; font-size: 14px; font-weight: 500;
  transition: border-color .2s;
  /* FIX: inputs must allow user input */
  user-select: text; -webkit-user-select: text;
}
.chat-input::placeholder { color: rgba(255,255,255,.38); }
.chat-input:focus { border-color: var(--c-primary-lt); }
.chat-send {
  width: 48px; height: 48px; border-radius: 50%; flex-shrink: 0;
  background: var(--c-primary); border: none; cursor: pointer; color: #fff;
  display: grid; place-items: center;
  box-shadow: 0 4px 16px rgba(91,79,207,.5);
  transition: transform .12s, box-shadow .12s;
}
.chat-send .ms { font-size: 22px; }
.chat-send:active { transform: scale(.88); box-shadow: 0 2px 8px rgba(91,79,207,.3); }

/* Float bubbles */
#floats {
  position: absolute; left: 14px; z-index: 35; pointer-events: none;
  bottom: calc(108px + var(--safe-b));
  display: flex; flex-direction: column; gap: 7px;
}
.float-pill {
  display: inline-flex; align-items: center; gap: 7px;
  background: rgba(8,5,20,.82); backdrop-filter: blur(12px);
  border: 1px solid rgba(255,255,255,.12); border-radius: var(--r-pill);
  padding: 8px 16px; color: #fff; font-size: 13px; font-weight: 600;
  animation: floatUp 4.5s ease-out forwards;
  max-width: 220px;
  overflow: hidden;
}
.float-pill .ms { font-size: 15px; color: var(--c-primary-lt); flex-shrink: 0; }
@keyframes floatUp {
  0%   { opacity:0; transform:translateY(8px); }
  10%  { opacity:1; transform:none; }
  78%  { opacity:1; }
  100% { opacity:0; transform:translateY(-10px); }
}

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   CONTROLS DOCK
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
.dock {
  position: fixed;
  bottom: calc(20px + var(--safe-b));
  left: 50%; transform: translateX(-50%);
  z-index: 50;
  display: flex; align-items: center; gap: 10px;
  background: rgba(10,7,24,.88); backdrop-filter: blur(28px) saturate(1.8);
  border: 1px solid rgba(255,255,255,.1);
  border-radius: var(--r-pill);
  padding: 10px 16px;
  box-shadow: 0 16px 52px rgba(0,0,0,.7), 0 2px 8px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.07);
}

.db {
  width: 52px; height: 52px; border-radius: 50%; border: none;
  display: grid; place-items: center; cursor: pointer;
  background: rgba(255,255,255,.1); color: rgba(255,255,255,.9);
  position: relative; transition: background .15s, transform .12s;
}
.db .ms { font-size: 23px; }
.db:active { transform: scale(.86); }
.db:hover { background: rgba(255,255,255,.17); }

/* Muted state */
.db.muted { background: rgba(239,68,68,.22); color: #fca5a5; }
.db.muted:hover { background: rgba(239,68,68,.3); }

/* Chat badge dot */
.db-chat .badge {
  position: absolute; top: 9px; right: 9px;
  width: 9px; height: 9px; border-radius: 50%;
  background: #ef4444; border: 2px solid rgba(10,7,24,.88);
  display: none;
}

/* End call */
.db-end {
  background: #ef4444 !important;
  box-shadow: 0 4px 20px rgba(239,68,68,.5), inset 0 1px 0 rgba(255,255,255,.2);
  width: 58px; height: 58px;
}
.db-end:hover { background: #dc2626 !important; }
.db-end .ms { font-size: 26px; }

/* Next */
.db-next {
  background: #ffffff !important; color: #1a1625 !important;
  box-shadow: 0 4px 16px rgba(255,255,255,.2), inset 0 1px 0 rgba(255,255,255,.9);
}
.db-next:hover { background: #ede9ff !important; }

.dock-sep { width: 1px; height: 30px; background: rgba(255,255,255,.1); margin: 0 2px; }

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   SPLASH SCREEN
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
#splash {
  position: fixed; inset: 0; z-index: 9999;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  background: linear-gradient(160deg, #3730c4 0%, #6b3bc9 55%, #9333ea 100%);
  transition: opacity .5s ease, visibility 0s .5s;
}
#splash.hide {
  opacity: 0; visibility: hidden;
}
.splash-logo {
  width: 110px; height: 110px; border-radius: 30px;
  background: rgba(255,255,255,.15); backdrop-filter: blur(10px);
  border: 2px solid rgba(255,255,255,.25);
  display: grid; place-items: center; overflow: hidden;
  box-shadow: 0 16px 48px rgba(0,0,0,.3), 0 0 0 1px rgba(255,255,255,.1);
  animation: splashPop .5s cubic-bezier(.22,.9,.22,1) both;
}
.splash-logo img {
  width: 100%; height: 100%; object-fit: cover; display: block;
}
.splash-name {
  margin-top: 20px;
  font-size: 32px; font-weight: 900; color: #fff;
  letter-spacing: -1px;
  animation: splashPop .5s .08s cubic-bezier(.22,.9,.22,1) both;
}
.splash-tagline {
  margin-top: 6px;
  font-size: 13px; font-weight: 500; color: rgba(255,255,255,.65);
  letter-spacing: .3px;
  animation: splashPop .5s .16s cubic-bezier(.22,.9,.22,1) both;
}
.splash-dots {
  display: flex; gap: 7px; margin-top: 48px;
  animation: splashPop .5s .28s cubic-bezier(.22,.9,.22,1) both;
}
.splash-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: rgba(255,255,255,.45);
  animation: splashDot 1.1s ease-in-out infinite;
}
.splash-dot:nth-child(2) { animation-delay: .18s; }
.splash-dot:nth-child(3) { animation-delay: .36s; }
@keyframes splashDot {
  0%,80%,100% { transform: scale(1);   opacity: .45; }
  40%          { transform: scale(1.5); opacity: 1;   }
}
@keyframes splashPop {
  from { opacity: 0; transform: translateY(14px) scale(.95); }
  to   { opacity: 1; transform: translateY(0)    scale(1);   }
}


#toast {
  position: fixed; top: calc(18px + var(--safe-t)); left: 50%;
  transform: translateX(-50%) translateY(-4px) scale(.96);
  background: rgba(16,12,36,.96); backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,.12);
  color: #fff; padding: 11px 24px; border-radius: var(--r-pill);
  font-size: 14px; font-weight: 700;
  opacity: 0; pointer-events: none;
  transition: opacity .25s ease, transform .28s cubic-bezier(.22,.9,.22,1);
  z-index: 999; white-space: nowrap;
  box-shadow: 0 8px 32px rgba(0,0,0,.4);
}
#toast.show {
  opacity: 1; transform: translateX(-50%) translateY(0) scale(1);
}

</style>
</head>
<body>

<!-- â”â”â” SPLASH â”â”â” -->
<div id="splash">
  <div class="splash-logo">
    <img src="https://" alt="HaiMeet" onerror="this.style.display='none'; this.parentNode.innerHTML='<span class=\'ms\' style=\'font-size:56px;color:#fff;\'>waving_hand</span>'">
  </div>
  <div class="splash-name">HaiMeet</div>
  <div class="splash-tagline">Meet Strangers Instantly</div>
  <div class="splash-dots">
    <div class="splash-dot"></div>
    <div class="splash-dot"></div>
    <div class="splash-dot"></div>
  </div>
</div>


<div id="toast"></div>

<!-- â”â”â” OVERLAY â”â”â” -->
<div class="overlay" id="overlay" onclick="closeSheet()"></div>

<!-- â”â”â” SETTINGS SHEET â”â”â” -->
<div class="sheet" id="sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-head">
    <div class="sheet-head-icon"><span class="ms">tune</span></div>
    <span class="sheet-head-title">Preferences</span>
  </div>

  <div class="setting-row">
    <div class="setting-left">
      <div class="setting-icon"><span class="ms">mic</span></div>
      <div>
        <div class="setting-label">Microphone</div>
        <div class="setting-sub">Required for voice chat</div>
      </div>
    </div>
    <input type="checkbox" class="toggle" id="micToggle" checked>
  </div>

  <div class="setting-row">
    <div class="setting-left">
      <div class="setting-icon"><span class="ms">videocam</span></div>
      <div>
        <div class="setting-label">Camera</div>
        <div class="setting-sub">Required for video chat</div>
      </div>
    </div>
    <input type="checkbox" class="toggle" id="camToggle" checked>
  </div>

  <button class="sheet-btn" onclick="closeSheet()">Done</button>
</div>

<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
     DASHBOARD
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<div id="dash" class="view active">
  <div class="topbar">
    <div class="brand">
      <div class="brand-mark"><span class="ms">waving_hand</span></div>
      <span class="brand-name">HaiMeet</span>
    </div>
    <div class="topbar-right">
      <div class="icon-btn" id="themeBtn" onclick="toggleTheme()">
        <span class="ms" id="themeIcon">dark_mode</span>
      </div>
      <div class="icon-btn" onclick="openSheet()">
        <span class="ms">tune</span>
      </div>
    </div>
  </div>

  <div class="dash-inner">

    <!-- Hero -->
    <div class="hero">
      <div class="hero-blob hero-blob-1"></div>
      <div class="hero-blob hero-blob-2"></div>
      <div class="hero-chip">
        <div class="hero-live-dot"></div>
        <span class="ms" style="font-size:12px">language</span>
        Live Â· Worldwide
      </div>
      <div class="hero-title">Meet<br>Strangers<br>Instantly.</div>
      <div class="hero-sub">Free Â· Anonymous Â· Real-time video chat</div>
      <div class="hero-stats-row">
        <div class="hero-stat">
          <div class="hero-stat-num" id="statMatches">0</div>
          <div class="hero-stat-lbl">Matches</div>
        </div>
        <div class="hero-divider"></div>
        <div class="hero-stat">
          <div class="hero-stat-num" id="statTime">0m</div>
          <div class="hero-stat-lbl">Talk Time</div>
        </div>
      </div>
    </div>

    <!-- Name -->
    <div class="card">
      <div class="card-header">Display Name</div>
      <div class="card-body">
        <div class="name-input-wrap">
          <span class="ms">person</span>
          <input type="text" id="nameInput" class="name-input" placeholder="Your nameâ€¦" value="Stranger" oninput="saveSettings()">
        </div>
      </div>
    </div>

    <!-- Gender -->
    <div class="card">
      <div class="card-header">I am a</div>
      <div class="card-body">
        <div class="seg-track">
          <div class="seg-opt sel" id="iam-male" onclick="setGender('male')">
            <span class="ms">man</span> Boy
          </div>
          <div class="seg-opt" id="iam-female" onclick="setGender('female')">
            <span class="ms">woman</span> Girl
          </div>
        </div>
      </div>
    </div>

    <!-- Interest -->
    <div class="card">
      <div class="card-header">Interested In</div>
      <div class="card-body">
        <div class="seg-track">
          <div class="seg-opt sel" id="want-any" onclick="setInterest('any')">
            <span class="ms">diversity_3</span> Anyone
          </div>
          <div class="seg-opt" id="want-male" onclick="setInterest('male')">
            <span class="ms">man</span> Boys
          </div>
          <div class="seg-opt" id="want-female" onclick="setInterest('female')">
            <span class="ms">woman</span> Girls
          </div>
        </div>
      </div>
    </div>

  </div><!-- /dash-inner -->

  <button class="start-fab" onclick="startApp()">
    <span class="ms">video_call</span>
    Start Matching
  </button>
</div><!-- /dash -->

<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
     CALL VIEW
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<div id="call" class="view">

  <!-- Videos -->
  <div class="vids">
    <div class="vid-remote" id="vidRemote">

      <!-- Searching state -->
      <div class="search-screen" id="searchUI">
        <div class="radar">
          <span class="ms radar-icon">search</span>
          <div class="radar-r3"></div>
        </div>
        <div class="search-title">Finding your matchâ€¦</div>
        <div class="search-sub">Scanning globally</div>
        <div class="search-pulse-row">
          <div class="s-dot"></div>
          <div class="s-dot"></div>
          <div class="s-dot"></div>
        </div>
      </div>

      <video id="remoteVideo" autoplay playsinline></video>

      <!-- Partner tag -->
      <div class="partner-tag" id="partnerBadge">
        <div class="partner-avatar"><span class="ms">person</span></div>
        <span class="partner-name" id="pName">Stranger</span>
        <div class="partner-live"></div>
      </div>

      <!-- Timer -->
      <div class="timer-chip" id="timerChip">
        <span id="timerBadge">00:00</span>
      </div>

    </div>
  </div>

  <!-- Local PiP -->
  <div class="vid-local" id="vidLocal">
    <video id="localVideo" autoplay playsinline muted></video>
    <div class="vid-local-badge">You</div>
  </div>

  <!-- Float bubbles -->
  <div id="floats"></div>

  <!-- Chat -->
  <div class="chat-wrap" id="chatWrap">
    <div class="chat-msgs" id="chatBox"></div>
    <div class="chat-input-row">
      <input type="text" id="msgInput" class="chat-input" placeholder="Messageâ€¦" maxlength="100" autocomplete="off">
      <button class="chat-send" onclick="sendMsg()"><span class="ms">send</span></button>
    </div>
  </div>

  <!-- Dock -->
  <div class="dock">
    <button class="db db-chat" id="chatBtn" onclick="toggleChat()" title="Chat">
      <span class="ms">chat_bubble</span>
      <div class="badge" id="chatBadge"></div>
    </button>
    <button class="db" id="muteBtn" onclick="toggleMute()" title="Mute">
      <span class="ms" id="muteIcon">mic</span>
    </button>
    <button class="db" onclick="switchCamera()" title="Flip Camera">
      <span class="ms">cameraswitch</span>
    </button>
    <div class="dock-sep"></div>
    <button class="db db-end" onclick="manualGoHome()" title="End Call">
      <span class="ms">call_end</span>
    </button>
    <button class="db db-next" onclick="nextMatch()" title="Next">
      <span class="ms">skip_next</span>
    </button>
  </div>

</div><!-- /call -->

<!-- â”â”â” Firebase â”â”â” -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Firebase
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const fbConfig = {
  apiKey:      "AIzaSyDRjAklTo6mdHZlFX3DThqXR5r2qNXeh2Y",
  authDomain:  "bhaishayri.firebaseapp.com",
  databaseURL: "https://bhaishayri-default-rtdb.firebaseio.com",
  projectId:   "bhaishayri",
  appId:       "1:153401409924:web:a992b96184076fca19ddd1"
};
if (!firebase.apps.length) firebase.initializeApp(fbConfig);
const db = firebase.database();

const ICE = {
  iceServers: [
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: "turn:openrelay.metered.ca:80",          username: "openrelayproject", credential: "openrelayproject" },
    { urls: "turn:openrelay.metered.ca:443",         username: "openrelayproject", credential: "openrelayproject" },
    { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
  ]
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   State
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let stream = null, pc = null, dc = null;
const myId = localStorage.getItem('zid') || ('u_' + Math.random().toString(36).slice(2, 8));
localStorage.setItem('zid', myId);

let myGender   = 'male';
let myInterest = 'any';
let stats      = JSON.parse(localStorage.getItem('zstats') || '{"matches":0,"time":0}');
let sessionStart = 0, timerInt = null, callId = null, facing = 'user', chatOpen = false;
let toastTimer = null;

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   DOM helpers â€” defined after DOM is ready
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const $ = id => document.getElementById(id);

/* Cached refs â€” assigned inside window.onload to guarantee DOM exists */
let $dash, $call, $search, $pBadge, $tChip;

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Boot â€” FIX: all DOM access inside onload
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window.onload = () => {
  $dash   = $('dash');
  $call   = $('call');
  $search = $('searchUI');
  $pBadge = $('partnerBadge');
  $tChip  = $('timerChip');

  /* FIX: keypress listener moved inside onload so element exists */
  $('msgInput').addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMsg();
  });

  loadSettings();
  updateStats();

  /* Hide splash after 2 seconds */
  setTimeout(() => {
    const splash = $('splash');
    if (splash) {
      splash.classList.add('hide');
      setTimeout(() => { if (splash.parentNode) splash.remove(); }, 500);
    }
  }, 2000);
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Theme
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  localStorage.setItem('zt', t);
  $('themeIcon').textContent = t === 'dark' ? 'light_mode' : 'dark_mode';
  /* FIX: setAttribute instead of .content â€” more reliable cross-browser */
  const metaTheme = document.querySelector('meta[name="theme-color"]');
  if (metaTheme) metaTheme.setAttribute('content', t === 'dark' ? '#1a1728' : '#5b4fcf');
}
function toggleTheme() {
  setTheme(document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Settings / Stats
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function loadSettings() {
  setTheme(localStorage.getItem('zt') || 'light');
  $('nameInput').value = localStorage.getItem('zname') || 'Stranger';
}
function saveSettings() {
  localStorage.setItem('zname', $('nameInput').value);
}
function updateStats() {
  $('statMatches').textContent = stats.matches;
  $('statTime').textContent    = Math.floor(stats.time) + 'm';
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Settings Sheet
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function openSheet()  { $('overlay').classList.add('open');    $('sheet').classList.add('open');    }
function closeSheet() { $('overlay').classList.remove('open'); $('sheet').classList.remove('open'); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Gender / Interest
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setGender(g) {
  myGender = g;
  ['male', 'female'].forEach(x => $('iam-' + x).classList.toggle('sel', x === g));
}
function setInterest(i) {
  myInterest = i;
  ['any', 'male', 'female'].forEach(x => $('want-' + x).classList.toggle('sel', x === i));
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   App navigation
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function startApp() {
  if (!$('micToggle').checked || !$('camToggle').checked) {
    openSheet();
    showToast('Enable camera & mic first ğŸ”’');
    return;
  }
  history.pushState({ p: 'call' }, '', '#call');
  $dash.classList.remove('active');
  $call.classList.add('active');
  initLocal();
}

window.addEventListener('popstate', () => {
  /* FIX: only run goHome if we are actually in the call view */
  if ($call && $call.classList.contains('active')) {
    goHome();
  }
});

function manualGoHome() { history.back(); }

function goHome() {
  /* Save session time */
  if (sessionStart > 0) {
    stats.time += (Date.now() - sessionStart) / 60000;
    localStorage.setItem('zstats', JSON.stringify(stats));
    updateStats();
    sessionStart = 0;
  }
  cleanup();
  $call.classList.remove('active');
  $dash.classList.add('active');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Media
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function initLocal() {
  $search.style.display = 'flex';
  $pBadge.style.display = 'none';
  $tChip.style.display  = 'none';
  $('remoteVideo').srcObject = null;

  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: facing },
      audio: { echoCancellation: true, noiseSuppression: true }
    });
    const v = $('localVideo');
    v.srcObject = stream;
    v.style.transform = facing === 'user' ? 'scaleX(-1)' : '';

    /* Respect existing mute state across nextMatch cycles */
    const aTrack = stream.getAudioTracks()[0];
    const isMuted = $('muteBtn').classList.contains('muted');
    if (aTrack) aTrack.enabled = !isMuted;
    $('muteIcon').textContent = (aTrack && aTrack.enabled) ? 'mic' : 'mic_off';

    findMatch();
  } catch (e) {
    console.error('getUserMedia error:', e);
    showToast('Camera / mic access denied');
    /* FIX: use history.back() so popstate fires and cleans up properly */
    manualGoHome();
  }
}

function toggleMute() {
  if (!stream) return;
  const t = stream.getAudioTracks()[0];
  if (!t) return;
  t.enabled = !t.enabled;
  $('muteIcon').textContent = t.enabled ? 'mic' : 'mic_off';
  $('muteBtn').classList.toggle('muted', !t.enabled);
  showToast(t.enabled ? 'Mic on' : 'Mic muted');
}

async function switchCamera() {
  /* FIX: stop only video tracks, preserve audio tracks */
  if (stream) stream.getVideoTracks().forEach(t => t.stop());

  facing = facing === 'user' ? 'environment' : 'user';
  try {
    const ns = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: facing },
      audio: { echoCancellation: true, noiseSuppression: true }
    });

    /* Preserve mute state */
    const at = ns.getAudioTracks()[0];
    const isMuted = $('muteBtn').classList.contains('muted');
    if (at) at.enabled = !isMuted;

    const v = $('localVideo');
    v.srcObject = ns;
    v.style.transform = facing === 'user' ? 'scaleX(-1)' : '';

    /* Replace tracks in peer connection if connected */
    if (pc) {
      const vSnd = pc.getSenders().find(s => s.track && s.track.kind === 'video');
      const aSnd = pc.getSenders().find(s => s.track && s.track.kind === 'audio');
      if (vSnd && ns.getVideoTracks()[0]) vSnd.replaceTrack(ns.getVideoTracks()[0]);
      if (aSnd && at)                     aSnd.replaceTrack(at);
    }

    /* FIX: stop old audio tracks AFTER new stream is established */
    if (stream) stream.getAudioTracks().forEach(t => t.stop());
    stream = ns;

  } catch (e) {
    console.error('switchCamera error:', e);
    showToast('Camera switch failed');
    /* Revert facing direction since switch failed */
    facing = facing === 'user' ? 'environment' : 'user';
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Cleanup
   FIX: stream set to null after stopping tracks so
        initLocal() doesn't reference stale stream object.
   FIX: Firebase listeners fully removed before removing data.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function cleanup() {
  /* Stop peer connection */
  if (pc) {
    pc.ontrack               = null;
    pc.onicecandidate        = null;
    pc.onconnectionstatechange = null;
    pc.ondatachannel         = null;
    pc.close();
    pc = null;
  }

  /* Close data channel */
  if (dc) {
    dc.onopen    = null;
    dc.onmessage = null;
    dc.close();
    dc = null;
  }

  /* Stop all media tracks */
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null; /* FIX: clear reference */
  }

  /* Stop timer */
  clearInterval(timerInt);
  timerInt = null;

  /* Reset UI */
  $('chatBox').innerHTML  = '';
  $('floats').innerHTML   = '';
  $('msgInput').value     = '';
  $('chatWrap').classList.remove('open');
  $('chatBadge').style.display = 'none';
  chatOpen = false;

  /* Remove Firebase data */
  if (callId) {
    db.ref('calls/' + callId).off();   /* FIX: detach listeners before remove */
    db.ref('calls/' + callId).remove();
  }
  db.ref('calls/' + myId).off();       /* FIX: always remove own call listener */
  db.ref('queue/' + myId).remove();

  callId = null;
}

function nextMatch() {
  cleanup();
  /* FIX: only call initLocal if we're still in the call view */
  setTimeout(() => {
    if ($call && $call.classList.contains('active')) {
      initLocal();
    }
  }, 400);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Matching
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function findMatch() {
  const q = db.ref('queue');
  q.limitToFirst(15).once('value', snap => {
    let found = null;
    snap.forEach(child => {
      const u = child.val(), uid = child.key;
      if (uid !== myId && !found) {
        const interestOk = myInterest === 'any' || myInterest === u.gender;
        const theirOk    = u.interest === 'any'  || u.interest === myGender;
        if (interestOk && theirOk) found = uid;
      }
    });

    if (found) {
      q.child(found).transaction(() => null, (err, committed) => {
        if (committed) startCall(found, true);
        else           findMatch(); /* retry if transaction lost */
      });
    } else {
      /* Join queue and wait */
      const info = {
        name:     $('nameInput').value || 'Stranger',
        gender:   myGender,
        interest: myInterest
      };
      db.ref('queue/' + myId).set(info);
      db.ref('queue/' + myId).onDisconnect().remove();

      db.ref('calls/' + myId).on('value', snap => {
        const d = snap.val();
        if (d && d.offer) {
          db.ref('calls/' + myId).off();
          db.ref('queue/' + myId).remove();
          callId = myId;
          db.ref('calls/' + myId).onDisconnect().remove();
          startCall(d.callerId, false, d.offer, d.name);
        }
      });
    }
  });
}

async function startCall(partnerId, isCaller, offer, pName) {
  /* FIX: guard against stale call â€” stream must exist */
  if (!stream) return;

  callId = isCaller ? partnerId : myId;
  if (isCaller) db.ref('calls/' + callId).onDisconnect().remove();

  pc = new RTCPeerConnection(ICE);

  /* Data channel */
  if (isCaller) {
    dc = pc.createDataChannel('chat');
    setupChat();
  } else {
    pc.ondatachannel = e => { dc = e.channel; setupChat(); };
  }

  /* Add local tracks */
  stream.getTracks().forEach(t => pc.addTrack(t, stream));

  /* Remote track received â†’ call connected */
  pc.ontrack = e => {
    $('remoteVideo').srcObject = e.streams[0];
    $search.style.display = 'none';
    $pBadge.style.display = 'flex';
    $tChip.style.display  = 'block';
    $('pName').textContent = pName || 'Stranger';
    stats.matches++;
    localStorage.setItem('zstats', JSON.stringify(stats));
    updateStats();
    sessionStart = Date.now();
    startTimer();
  };

  pc.onconnectionstatechange = () => {
    if (!pc) return;
    const s = pc.connectionState;
    if (s === 'disconnected' || s === 'failed' || s === 'closed') {
      showToast('Stranger disconnected');
      nextMatch();
    }
  };

  pc.onicecandidate = e => {
    if (e.candidate) {
      db.ref(`calls/${callId}/${isCaller ? 'caller' : 'callee'}`).push(e.candidate.toJSON());
    }
  };

  if (isCaller) {
    const o = await pc.createOffer();
    await pc.setLocalDescription(o);
    db.ref('calls/' + partnerId).set({
      offer:    { type: o.type, sdp: o.sdp },
      callerId: myId,
      name:     $('nameInput').value || 'Stranger'
    });
    db.ref('calls/' + partnerId).on('value', s => {
      const d = s.val();
      if (d && d.answer && !pc.currentRemoteDescription) {
        pc.setRemoteDescription(new RTCSessionDescription(d.answer));
      }
      if (d && d.name) $('pName').textContent = d.name;
    });
  } else {
    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    const a = await pc.createAnswer();
    await pc.setLocalDescription(a);
    db.ref('calls/' + myId).update({
      answer: { type: a.type, sdp: a.sdp },
      name:   $('nameInput').value || 'Stranger'
    });
  }

  /* Exchange ICE candidates */
  db.ref(`calls/${callId}/${isCaller ? 'callee' : 'caller'}`).on('child_added', s => {
    if (pc) pc.addIceCandidate(new RTCIceCandidate(s.val())).catch(() => {});
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Chat
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleChat() {
  chatOpen = !chatOpen;
  $('chatWrap').classList.toggle('open', chatOpen);
  if (chatOpen) {
    $('chatBadge').style.display = 'none';
    $('msgInput').focus();
  }
}

function setupChat() {
  dc.onopen    = () => showToast('Chat connected ğŸ’¬');
  dc.onmessage = e => {
    addBubble(e.data, 'them');
    if (!chatOpen) {
      addFloat(e.data);
      $('chatBadge').style.display = 'block';
    }
  };
  /* FIX: handle data channel errors gracefully */
  dc.onerror = () => showToast('Chat error');
}

function sendMsg() {
  const inp = $('msgInput');
  const msg = inp.value.trim();
  if (!msg) return;
  if (!dc || dc.readyState !== 'open') {
    showToast('Chat not connected yet');
    return;
  }
  dc.send(msg);
  addBubble(msg, 'me');
  inp.value = '';
  inp.focus();
}

function addBubble(msg, who) {
  const box = $('chatBox');
  const d   = document.createElement('div');
  d.className   = 'bubble' + (who === 'me' ? ' me' : '');
  d.textContent = msg;
  box.appendChild(d);
  box.scrollTop = box.scrollHeight;
}

function addFloat(msg) {
  const area = $('floats');
  const el   = document.createElement('div');
  el.className = 'float-pill';
  /* FIX: use textContent for the message part to prevent XSS */
  const icon = document.createElement('span');
  icon.className   = 'ms';
  icon.textContent = 'chat';
  const txt = document.createElement('span');
  txt.textContent  = msg.length > 38 ? msg.slice(0, 38) + 'â€¦' : msg;
  el.appendChild(icon);
  el.appendChild(txt);
  area.appendChild(el);
  setTimeout(() => { if (el.parentNode) el.remove(); }, 4500);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Timer
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function startTimer() {
  let s = 0;
  clearInterval(timerInt);
  timerInt = setInterval(() => {
    s++;
    /* FIX: use padStart for proper MM:SS formatting without Date parsing quirks */
    const mm = String(Math.floor(s / 60)).padStart(2, '0');
    const ss = String(s % 60).padStart(2, '0');
    $('timerBadge').textContent = mm + ':' + ss;
  }, 1000);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Toast
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showToast(msg) {
  const t = $('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Cleanup on page unload
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window.addEventListener('beforeunload', cleanup);
</script>
</body>
</html>
